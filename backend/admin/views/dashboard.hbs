<h2>Admin Dashboard</h2>
<p>Welcome, {{#if user}}{{user.name}}{{user.username}}{{else}}Admin{{/if}}!</p>

<div class="container-fluid">
  <!-- Stat Cards: 2 rows, 3 columns each -->
  <div class="row mb-4 g-3">
    <!-- Row 1 -->
    <div class="col-12 col-md-4">
      <div class="card text-white bg-primary border-0 shadow-sm">
        <div class="card-body pb-0 d-flex justify-content-between align-items-start">
          <div>
            <div class="fs-2 fw-bold">{{stats.users}}</div>
            <div class="text-white-50">Users</div>
          </div>
          <i class="icon cil-people fs-1 opacity-50"></i>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card text-white bg-info border-0 shadow-sm">
        <div class="card-body pb-0 d-flex justify-content-between align-items-start">
          <div>
            <div class="fs-2 fw-bold">{{stats.products}}</div>
            <div class="text-white-50">Products</div>
          </div>
          <i class="icon cil-box fs-1 opacity-50"></i>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card text-white bg-warning border-0 shadow-sm">
        <div class="card-body pb-0 d-flex justify-content-between align-items-start">
          <div>
            <div class="fs-2 fw-bold">{{stats.orders}}</div>
            <div class="text-white-50">Orders</div>
          </div>
          <i class="icon cil-cart fs-1 opacity-50"></i>
        </div>
      </div>
    </div>
    <!-- Row 2 -->
    <div class="col-12 col-md-4">
      <div class="card text-white bg-success border-0 shadow-sm">
        <div class="card-body pb-0 d-flex justify-content-between align-items-start">
          <div>
            <div class="fs-2 fw-bold">{{stats.categories}}</div>
            <div class="text-white-50">Categories</div>
          </div>
          <i class="icon cil-layers fs-1 opacity-50"></i>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card text-white bg-secondary border-0 shadow-sm">
        <div class="card-body pb-0 d-flex justify-content-between align-items-start">
          <div>
            <div class="fs-2 fw-bold">{{stats.subcategories}}</div>
            <div class="text-white-50">Subcategories</div>
          </div>
          <i class="icon cil-list-rich fs-1 opacity-50"></i>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card text-white bg-dark border-0 shadow-sm">
        <div class="card-body pb-0 d-flex justify-content-between align-items-start">
          <div>
            <div class="fs-2 fw-bold">
              {{#if stats.sales}}
                {{formatDate stats.sales "currency"}}
              {{else}}
                0
              {{/if}}
            </div>
            <div class="text-white-50">Total Sales</div>
          </div>
          <i class="icon cil-dollar fs-1 opacity-50"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart Card -->
  <div class="row mb-4">
    <div class="col-lg-12">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex align-items-center">
          <i class="icon cil-chart-line me-2"></i>
          <span class="fw-semibold">Monthly Insights</span>
        </div>
        <div class="card-body bg-light">
          <div id="mainChart"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Users Table Card -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle border mb-0">
          <thead class="bg-light">
            <tr>
              <th>User</th>
              <th>Email</th>
              <th>Role</th>
              <th class="text-center">Total Orders</th>
              <th>Activity</th>
            </tr>
          </thead>
          <tbody>
            {{#each users}}
            <tr>
              <td>
                <div class="d-flex align-items-center">
                  <div class="avatar avatar-md bg-primary text-white fw-bold me-2">
                    {{name.[0]}}
                  </div>
                  <div>
                    <div class="fw-semibold">{{name}}</div>
                    <div class="small text-muted">
                      <span>
                        {{#if new}}
                          <span class="badge bg-success">New</span>
                        {{else}}
                          Recurring
                        {{/if}}
                      </span> | {{registered}}
                    </div>
                  </div>
                </div>
              </td>
              <td>{{email}}</td>
              <td>
                <span class="badge bg-primary text-white text-capitalize">{{role}}</span>
              </td>
              <td class="text-center">
                <span class="badge bg-info fs-6">
                  {{totalOrders}}
                </span>
              </td>
              <td>
                <div class="small text-muted">Recent activity</div>
                <div class="fw-semibold">
                  {{#if activities}}
                    {{#each activities}}
                      <div class="text-truncate">{{this}}</div>
                    {{/each}}
                  {{else}}
                    <div class="text-muted">No recent activity</div>
                  {{/if}}
                </div>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
      <!-- Pagination (static demo) -->
      <nav aria-label="Users pagination">
        <ul class="pagination justify-content-center mt-3">
          <li class="page-item disabled"><a class="page-link" href="#" tabindex="-1">Previous</a></li>
          <li class="page-item active"><a class="page-link" href="#">1</a></li>
          <li class="page-item"><a class="page-link" href="#">2</a></li>
          <li class="page-item"><a class="page-link" href="#">3</a></li>
          <li class="page-item"><a class="page-link" href="#">Next</a></li>
        </ul>
      </nav>
    </div>
  </div>
</div>

<!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
let apexChartInstance = null;

function getApexThemeMode() {
  return document.body.classList.contains('light-theme') ? 'light' : 'dark';
}
function getApexColors(theme) {
  return theme === 'dark'
    ? ['#a7bfff', '#4ade80', '#60a5fa', '#22d3ee', '#fbbf24', '#f87171']
    : ['#5856d6', '#1b9e3e', '#39f', '#06b6d4', '#f59e42', '#ef4444'];
}
function getApexLabelColor(theme) {
  return theme === 'dark' ? '#e5e7eb' : '#323a49';
}
function getApexGridColor(theme) {
  return theme === 'dark' ? '#374151' : '#e7eaee';
}
function getApexTooltipTheme(theme) {
  return theme === 'dark' ? 'dark' : 'light';
}

function renderApexChart(data) {
  if (apexChartInstance) {
    apexChartInstance.destroy();
  }
  const themeMode = getApexThemeMode();
  const colors = getApexColors(themeMode);
  const labelColor = getApexLabelColor(themeMode);
  const gridColor = getApexGridColor(themeMode);
  const tooltipTheme = getApexTooltipTheme(themeMode);

  var options = {
    chart: {
      type: 'line',
      height: 350,
      toolbar: { show: false },
      background: 'transparent'
    },
    theme: {
      mode: themeMode
    },
    stroke: {
      curve: 'smooth',
      width: 4
    },
    markers: {
      size: 5,
      hover: { size: 8 }
    },
    series: [
      {
        name: 'Orders',
        data: data.orders,
        color: colors[0]
      },
      {
        name: 'Sales',
        data: data.sales,
        color: colors[1]
      },
      {
        name: 'New Users',
        data: data.users,
        color: colors[2]
      },

    ],
    xaxis: {
      categories: data.labels,
      labels: { style: { colors: labelColor } },
      axisBorder: { color: gridColor },
      axisTicks: { color: gridColor }
    },
    yaxis: [
      {
        title: { text: 'Orders / Users / Categories', style: { color: labelColor } },
        labels: { style: { colors: labelColor } },
        axisBorder: { color: gridColor },
        axisTicks: { color: gridColor }
      },
      {
        opposite: true,
        title: { text: 'Sales', style: { color: colors[1] } },
        labels: {
          style: { colors: colors[1] },
          formatter: function (val) {
            return val.toLocaleString('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 });
          }
        },
        axisBorder: { color: colors[1] },
        axisTicks: { color: colors[1] }
      }
    ],
    grid: {
      borderColor: gridColor
    },
    tooltip: {
      theme: tooltipTheme,
      shared: true,
      intersect: false,
      y: {
        formatter: function (val, { series, seriesIndex }) {
          if (seriesIndex === 1) {
            return val.toLocaleString('en-IN', { style: 'currency', currency: 'INR' });
          }
          return val;
        }
      }
    },
    legend: {
      position: 'top',
      horizontalAlign: 'right',
      labels: { colors: [labelColor, colors[1], colors[2], colors[3], colors[4]] }
    }
  };
  apexChartInstance = new ApexCharts(document.querySelector("#mainChart"), options);
  apexChartInstance.render();
}

function fetchAndRenderChart() {
  fetch('/admin/chart-data')
    .then(res => res.json())
    .then(data => renderApexChart(data))
    .catch(err => {
      document.querySelector("#mainChart").innerHTML = '<div class="text-danger">Failed to load chart data.</div>';
      console.error('ApexCharts error:', err);
    });
}

// Chart rendering and theme update observer
document.addEventListener('DOMContentLoaded', function () {
  fetchAndRenderChart();
  // Listen for theme changes (body class change)
  const observer = new MutationObserver(() => {
    fetchAndRenderChart();
  });
  observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
});
</script>
